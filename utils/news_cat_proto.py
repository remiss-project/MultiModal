#!/usr/bin/env python
# coding: utf-8
import ast
import numpy as np
import json
import pdb
import networkx as nx
import random



###############---
graph_rules_combined = { 
     "Text Preprocessing Rule": "Break up complex or long sentences into smaller coherent sentences. Restructure the text to explicitly state possession or agency, ensuring that all implied words, particularly those related to ownership or action, are explicitly stated. Use possessive pronouns or nouns, active voice constructions, clarifying phrases or clauses, and rearrange sentences or clauses as necessary to achieve clarity and explicitness. Resolve pronouns to full names for clear understanding. Converts all spelled-out numbers such as 'two' or 'three hundred', that indicate quantity or rank, into their numerical equivalents, such as '2' or '300, respectively. Dont convert when they are part of a named entity like 'Air Force one','Formula One','7-Eleven' etc. ",
     "Entity Detection and Node Creation Rule ":  "Utilize Named Entity Recognition (NER) techniques to identify All named entities in the text. Named entities encompass specific entities that have names, including persons, locations, organizations, dates, etc. Ensure each entity is distinct and unambiguous by resolving entities to their official or most commonly recognized names. Perform entity normalization, splitting composite entities when necessary. Follow the categorization in <<< {'LOCATION': 'Entities representing specific places or geographic locations.', 'PERSON': 'Entities representing individuals, including names of people, titles, positions, etc.', 'ORGANIZATION': 'Entities representing companies, institutions, groups, or any organized entity.', 'DATE': 'Entities representing specific dates, including days of the week, months, years, holidays, etc.', 'TIME': 'Entities representing specific times or time intervals.', 'CARDINAL': 'Entities representing numerical quantities or counts.', 'ORDINAL': 'Entities representing positions in a sequence or ranking.', 'EVENT': 'Entities representing specific events or occurrences like protests, attacks, demonstrations, conflicts, marches, and things like these.  It is of utmost importance that you detect words related to violence, conflict, disruption, protest, damage or propaganda in the text. You must find such keywords or related keywords if they exist in the text no matter how they are present. If such words keywords or related keywords are in the text , you must ensure that they are also present in the entity relationship graph you output, as entity type event, and relate them to other detected entities following causal reasoning, like who did what to whom.', 'PRODUCT': 'Entities representing specific products or items.'} >>> . I Emphasize that entities names are simplified for better representation. For instance, represent 'President of the USA' as two distinct entities, ('President', {'ent_type': 'Person', 'data': 'President of the USA'}) and ('USA', {'ent_type': 'LOCATION', 'data': 'United States of America'}). For instance, even when the 'of' is implied, as in 'Thai National Flag', represent it as 'National Flag of Thailand' and then break it down into separate entities: 'National Flag' as {'ent_type': 'ENTITY', 'data': 'National Flag'}, and 'Thailand' as {'ent_type': 'LOCATION', 'data': 'Thailand, Asia'}. Similarly, for composite entities like 'New York City Police Department', break them down into 'New York City' as {'ent_type': 'LOCATION', 'data': 'New York City, USA'}, and 'Police Department' as {'ent_type': 'ORGANIZATION', 'data': 'Police Department'}. Resolve acronyms to their full forms for clarity. For example, expand 'NASA' to 'National Aeronautics and Space Administration' as {'ent_type': 'ORGANIZATION', 'data': 'National Aeronautics and Space Administration, USA'}.  Encode the entity type as 'ent_type' and provide detailed information within the 'data' field including always the full name, type of thing, brand or manufacturer, relevant details about the entity, and geographic location if applicable. For example, 'Dreamliner' should be {'ent_type': 'THING', 'data': 'Dreamliner is a long-haul airliner from Boeing'}.  To fill the data field, you must follow these entity type specfic guidelines <<< { 'LOCATION': Add Details about location in terms of city, state, country. Example: ('New York City', {'ent_type': 'LOCATION', 'data': 'New York City, New York, USA'}),  'PERSON': Add Full name, if full name is not present, try to guess from context, and official designation. Example: ('Barack Obama', {'ent_type': 'PERSON', 'data': 'Barack Obama is an American politician who served as the 44th president of the United States from 2009 to 2017. A member of the Democratic Party'}),  'ORGANIZATION': Add Full Name of Organization and brief description of what it involved in. Example: ('United Nations', {'ent_type': 'ORGANIZATION', 'data': 'United Nations is an international organization working for peace and security'}),  'DATE': Add Details about which day of the week, months, years, holidays. Example: ('Sept 18 2012', {'ent_type': 'DATE', 'data': 'Tuesday, September 18, 2012'}),  'TIME': Add details about the time is measuring. Example: ('3:30 PM', {'ent_type': 'TIME', 'data': '3:30 PM'}),  'CARDINAL': Add details, using context, to describe what the number counts. Example: ('Three', {'ent_type': 'CARDINAL', 'data': 'Three apples'}),  'ORDINAL': Describe the ranking from context. Example: ('First', {'ent_type': 'ORDINAL', 'data': 'First place'}),  'EVENT': Add details about the specific kind of event in terms of protest, attack, demonstration, conflict, march, and things like these from the text context. Example: ('Protest', {'ent_type': 'EVENT', 'data': 'Protest against climate change'}),  'PRODUCT': Add details about what the product does, and who makes it. Example: ('iPhone', {'ent_type': 'PRODUCT', 'data': 'iPhone is a smartphone made by Apple Inc.'})}  >>> . YOU MUST FOLLOW THESE FORMAT FOR SPECIFYING DETAILS ABOUT THE DETECTED ENTITIES. This approach ensures consistent and clear representation of nodes throughout the graph. You must Ensure all entities are unique and there are no duplicates",
      "News Categorization" :"Your task now is to categorize the given text in to one of the news_categories {'Economy': 'News related to economics, finance, markets, companies, and business trends.','Technology': 'Coverage of advancements, innovations, and trends in the technology industry, including gadgets, software, and digital transformation as well as research findings, breakthroughs, and advancements across various scientific disciplines.','Politics': 'News and analysis on political developments, elections, government policies, and international relations.','Conflict': 'Coverage of conflicts, wars, uprisings, protests, terrorism, security issues, as well as activism, protests, and movements related to topics such as unemployment, inequality, human rights, and social justice.','Disasters': 'Coverage of natural disasters such as floods, earthquakes, hurricanes, wildfires, as well as man-made disasters, accidents, and emergencies.','Health':'Coverage of health issues, medical breakthroughs, research developments, healthcare policies, and public health initiatives.','Environment':'Coverage of environmental issues, climate change, conservation efforts, sustainability initiatives, and ecological challenges.','Culture': 'Articles on culture, entertainment, arts, fashion, travel, leisure, and lifestyle trends.','Sports': 'Coverage of sports events, scores, athlete profiles, sports industry news, and developments in the world of athletics.'} Then extract a keyword or phrase from  the input text that justifies your choice. At this point ask and answer the questions in the format specified"
    "Question Answering ":"### Tags Meanings:- `<det  xx det>`: Provides additional details xx about the node to its left.- `<act  xx act>`: Provides additional details xx about the action to its left.- `<e    xx   e>`: Denotes text-extracted named entities from the input text.### Name Meanings: - `named_entity`: Detected named entity of type 'PERSON', 'ORGANIZATION', 'EVENT', 'DATE', 'TIME', 'LOCATION', 'CARDINAL', 'ORDINAL', or 'PRODUCT'. - `named_entity_person_organization_event`: Detected named entity of type 'PERSON', 'ORGANIZATION', or 'EVENT'. - `named_entity_person_organization`: Detected named entity of type 'PERSON' or 'ORGANIZATION'.- `named_entity_event`: Detected named entity of type 'EVENT'. - `named_entity_date_time`: Detected named entity of type 'DATE' or 'TIME'.- `named_entity_location`: Detected named entity of type 'LOCATION'.- `category`: Selected category from news_categories based on the input text.# Instructions: Use the tag encoding and ask the following questions. Answer them in the specified format, then build the graph. ### ## 1. What is the category? - **Question**: What is the category? - **Answer**: News <act 'is about' act> category, because the text says <e xx e>. - **Example**: What is the category? : news <act 'is about' act> 'Conflict' + ',' + 'because the text says' <e 'flash mob protest at Central London' e>. - **Graph Format**: (`'Conflict'`, {'ent_type': 'News Category', 'data': 'flash mob protest at Central London'}) ## 2. What is the action about? - **Question**: What is the action about? - **Answer**: category <act 'is specifically about' act> <e named_entity_event e> <det exx det>. - **Example**: What is the action about? : 'Conflict' <act 'is specifically about' act> <e 'Flashmob Protest' e> <det exx det>. - **Graph Format**: (`'Conflict'`, 'Flashmob Protest', {'action': 'is specifically about'}),  (`'Flashmob Protest'`, {'ent_type': 'EVENT', 'data': 'Flashmob protest is gathering of people protesting'}) ## 3. Who is doing what? - **Question**: Who is doing what? - **Answer**: <e named_entity_person_organization e> <det exx det> <e named_entity_event e> <act axx act>. - **Example**: Who is doing what? : <e 'Unite union members' e> <det 'Unite union members is a labor union' det> <e 'Flashmob Protest' e> <act 'organize' act>. - **Graph Format**: (`'Unite union members'`, {'ent_type': 'ORGANIZATION', 'data': 'Unite union members is a labor union'}),                    (`'Unite union members'`, 'Flashmob Protest', {'action': 'organize'}) ## 4. What is the cause? - **Question**: What is the cause? - **Answer**: <e named_entity_event e> <act xx act> <e named_entity_person_organization e> <det exx det>. - **Example**: What is the cause? : <e 'Flashmob Protest' e> <act 'against' act> <e 'blacklisting and sackings of union officials and members' e>. - **Graph Format**: (`'Blacklisting and Sacking'`, {'ent_type': 'ACTION', 'data': 'Blacklisting is a discriminatory practice'}), (`'Union officials and members'`, {'ent_type': 'PERSON', 'data': 'Union officials is union representatives'}),  ('Flashmob Protest'`, 'Blacklisting and Sacking', {'action': 'against'}) ## 5. Where is this happening? - **Question**: Where is this happening? - **Answer**: <e named_entity_event e> <act 'at place' act> <e named_entity_location e> <det exx det>. - **Example**: Where is this happening? : <e 'Flashmob Protest' e> <act 'at place' act> <e 'Crossrail site in Central London' e>. - **Graph Format**: (`'Crossrail site'`, {'ent_type': 'LOCATION', 'data': 'Crossrail site is a construction site'}),   (`'Central London'`, {'ent_type': 'LOCATION', 'data': 'Central London is a city area in London, UK'}), (`'Flashmob Protest'`, 'Crossrail site', {'action': 'at place'}), (`'Crossrail site'`, 'Central London', {'action': 'located in'}) ## 6. When is this happening? - **Question**: When is this happening? - **Answer**: <e named_entity_event e> <act 'in time' act> <named_entity_date_time> <det xx det>. - **Example**: When is this happening? : <e 'Flashmob Protest' e> <act 'at time' act> UNK. - **Graph Format**: (`'Flashmob Protest'`, {'ent_type': 'EVENT', 'data': 'UNK'}) ## End of Question"
     "Overall guideline" : " You must represent the text in terms of an entity relattionship graph highlighting peoples places actions and dates in the the text focusing on the generated question answer pairs ",
    "Verfication  Rule" : " Once you are done with the graph, apply the rules again to check if your graph is consistent. In particular check if the edges are consistent with the semantics of the text and the question answers generated,    if not retry from start. All actions described in edges must align with the actions attributed to entities in the text. Ensure that the graph is connected"

}



graph_format_ex = """
{
    'nodes': [('Protester',     {'ent_type': 'PERSON',   'data': 'Individual'}), 
              ('Protest',       {'ent_type': 'EVENT',    'data': 'Protest against Government'})
              ('Antigovernment',{'ent_type': 'CONCEPT',  'data': 'Against the Government'}),
              ('Thailand',      {'ent_type': 'LOCATION', 'data': 'Country in Asia'}), 
              ('National Flag', {'ent_type': 'THING',    'data': 'National Symbol'}), 
              ('Parliament',    {'ent_type': 'BUILDING', 'data': 'Government Building'}), 
              ('Bangkok',       {'ent_type': 'LOCATION', 'data': 'City in Thailand, Thailand is Country in Asia'})], 
    'edges': [('Protester'    , 'Protest'   ,    {'action': 'organize'}),
              ('Protester'    , 'Parliament'   , {'action': 'outside'}) 
              ('Parliament'   , 'Bangkok'      , {'action': 'located in'})
              ('Protester'    , 'National Flag', {'action': 'waves'})
              ('National Flag', 'Thailand'     , {'action': 'of'})
              ]
}

"""

graph_format_template = """
{
    'nodes': [('Node_1', {'attribute_1': 'value_1', 'attribute_2': 'value_2'}),
              ('Node_2', {'attribute_1': 'value_1', 'attribute_2': 'value_2'})],
    'edges': [('Node_1', 'Node_2', {'attribute_1': 'value_1'})]
}
"""

prompt_graph_const = f"You are a Journalist Assistant, and NLP expert. Your task is to look at a text story and generate a entity relationships graph representation that captures all entities and relationships. Follow all the rules defined in the <<{graph_rules_combined}>> to build this graph as a dictionary called er_dict. The output format must adhere to the specified template: {graph_format_template} and here is an example: {graph_format_ex}. A list of graph examples is provided ### '{graph_examples}'###.  Now for try this INPUT: '"+claim_text+"'. The output er_dict should be interpretable as  python dictionary when I apply ast.literal_eval(output). Only respond with the output  AND ABSOLUTELY NOTHING ELSE. Do not provide explanations."
 



graph_examples = [
    "Example 1 INPUT: 'Flashmob protest at Crossrail site in Central London by Unite union members in protest against blacklisting and sackings of union officials and members' ,  QA_OUTPUT: ' what  is the category?   : news <act  'is about' act> Conflict <det 'Because it is about flash mob protest at Central London' det>  what  is the action about   : Conflict <act  'is specifically about' act> protest <det'Flashmob protest'det>  who   is doing what        ?: <e 'Unite union members'e>  protest <act 'organize' act>  what  is the cause ?        : protest <act 'against' act> <e 'blacklisting and sackings of union officials and members' e>  ##resolving 'of'  what  is the cause ?        : protest <act 'against' act>  <e'blacklisting and sackings'e>  <det 'Blacklisting is a discriminatory practice' det> <act 'of' act> 'union officials and members'> <det 'Union officials is union representatives' det>  where is this happening ?  : protest  <act 'at place' act> <e'Crossrail site in Central London'e> ## resolving 'in'   where is this happening ?  : protest <act 'at place' act>  <e'Crossrail site'e> <det 'Crossrail site is a construction site' det> <act 'in' act> <e'Central London'e> <det 'Central London is a city area in London, UK' det>  when  is this happening ?   : protest  <act 'in time' act>   UNK ,  GRAPH_OUTPUT:'nodes': [  ('Conflict', {'ent_type': 'News Category', 'data': 'Because it is about flash mob protest'}), ('Flashmob protest',  {'ent_type': 'EVENT', 'data': 'Flashmob protest is gathering of people protesting '}),   ('Crossrail site', {'ent_type': 'LOCATION', 'data': 'Crossrail site is a construction site'}),  ('Central London', {'ent_type': 'LOCATION', 'data': 'Central London is a city area in London, UK'}),  ('Unite union members', {'ent_type': 'ORGANIZATION', 'data': 'Unite union members is a labor union'}),  ('Blacklisting and Sacking', {'ent_type': 'ACTION', 'data': 'Blacklisting is a discriminatory practice'}),   ('Union officials and members', {'ent_type': 'PERSON', 'data': 'Union officials is union representatives'})], 'edges':[('NEWS'               , 'Conflict'      ,   {'action': 'is about'}),      ('Conflict'           , 'protest'       ,   {'action': 'is specifically about'}),          ('Flashmob protest'   , 'Crossrail site',   {'action': 'at place '}),          ('Crossrail site'     , 'Central London',   {'action': 'located in'}),          ('Unite union members', 'Protest'       ,   {'action':  'organize'}),         ('Protest'            , 'Blacklisting and Sacking',         {'action': 'against'}),          ('Blacklisting and Sackings', 'Union officials and members', {'action': 'of'})]",

   "Example 2 INPUT: 'British Muslims campaign outside the BBC headquarters in London against negative media portrayals of Muslims', QA_OUTPUT: ' what  is the category?   : news <act  'is about' act> Conflict <det 'Because it is about British Muslims campaign outside the BBC headquarters in London against negative media portrayals of Muslims' det>  what  is the action about   : Conflict <act  'is specifically about' act> campaign <det'British Muslims campaign outside the BBC headquarters in London against negative media portrayals of Muslims' det>  who   is doing what        ?: <e 'British Muslims'e>  campaign <act 'campaign' act>  what  is the cause ?        : campaign <act 'against' act> <e 'negative media portrayals of Muslims' e>  where is this happening ?  : campaign  <act 'at place' act> <e'BBC headquarters in London'e>  when  is this happening ?   : campaign  <act 'in time' act>   UNK ,  GRAPH_OUTPUT: 'nodes': [  ('Conflict', {'ent_type': 'News Category', 'data': 'Because it is about British Muslims campaign outside the BBC headquarters in London against negative media portrayals of Muslims'}), ('Campaign',  {'ent_type': 'EVENT', 'data': 'Campaign is a form of collective action aiming to bring about social, political, or environmental change'}),   ('British Muslims', {'ent_type': 'ORGANIZATION', 'data': 'British Muslims'}), ('Negative Media Portrayals of Muslims', {'ent_type': 'ACTION', 'data': 'Negative media portrayals are portrayal that unfairly or inaccurately depict Muslims'}),   ('BBC headquarters', {'ent_type': 'LOCATION', 'data': 'BBC headquarters is the main office of the British Broadcasting Corporation'}),  ('London', {'ent_type': 'LOCATION', 'data': 'London is the capital city of England and the United Kingdom'})], 'edges':[('NEWS'               , 'Conflict'      ,   {'action': 'is about'}         ('Conflict'           , 'Campaign'       ,   {'action': 'is specifically about'}),         ('British Muslims'   , 'Campaign'       ,   {'action': 'organize'}),         ('Campaign'          , 'Negative Media Portrayals of Muslims', {'action': 'against'}),         ('Campaign'          , 'BBC headquarters', {'action': 'at place'})]",


    "Example 3 INPUT: 'After 15 minutes England were two up as Darren Bent netted from Youngs pass The Welsh could not muster a riposte', QA_OUTPUT: ' what  is the category?   : news <act  'is about' act> Sports <det 'Because it is about After 15 minutes England were two up as Darren Bent netted from Youngs pass The Welsh could not muster a riposte' det>  what  is the action about   : Sports <act  'is specifically about' act> match <det'England were two up as Darren Bent netted from Youngs pass The Welsh could not muster a riposte'det>  who   is doing what        ?: <e 'England'e>  match <act 'lead' act>  what  is the cause ?        : match <act 'from' act> <e 'Darren Bent netted from Youngs pass' e>  where is this happening ?  : match  <act 'at place' act> <e'15 minutes'e>  when  is this happening ?   : match  <act 'in time' act>   UNK ,  GRAPH_OUTPUT: 'nodes': [  ('Sports', {'ent_type': 'News Category', 'data': 'Because it is about After 15 minutes England were two up as Darren Bent netted from Youngs pass The Welsh could not muster a riposte'}), ('Match',  {'ent_type': 'EVENT', 'data': 'Match is a contest between two individuals or teams'}),   ('England', {'ent_type': 'LOCATION', 'data': 'England is a country that is part of the United Kingdom'}), ('Darren Bent netted from Youngs pass', {'ent_type': 'ACTION', 'data': 'Darren Bent netted from Youngs pass'}),   ('15 minutes', {'ent_type': 'TIME', 'data': '15 minutes'}),  ('The Welsh', {'ent_type': 'ORGANIZATION', 'data': 'The Welsh'})], 'edges':[('NEWS'               , 'Sports'      ,   {'action': 'is about'}),         ('Sports'           , 'Match'       ,   {'action': 'is specifically about'}),         ('England'   , 'Match'       ,   {'action': 'lead'}),         ('Match'          , 'Darren Bent netted from Youngs pass', {'action': 'from'}),         ('Match'          , '15 minutes', {'action': 'at place'})]",
    
    "Example 4 INPUT: 'An antigovernment protester waves a Thai national flag outside Parliament in Bangkok', QA_OUTPUT: ' what  is the category?   : news <act  'is about' act> Conflict <det 'Because it is about an antigovernment protester waves a Thai national flag outside Parliament in Bangkok' det>  what  is the action about   : Conflict <act  'is specifically about' act> protest <det'an antigovernment protester waves a Thai national flag outside Parliament in Bangkok'det>  who   is doing what        ?: <e 'antigovernment protester'e>  protest <act 'wave' act>  what  is the cause ?        : protest <act 'with' act> <e 'Thai national flag' e>  where is this happening ?  : protest  <act 'at place' act> <e'Parliament in Bangkok'e>  when  is this happening ?   : protest  <act 'in time' act>   UNK ,  GRAPH_OUTPUT: 'nodes': [  ('Conflict', {'ent_type': 'News Category', 'data': 'Because it is about an antigovernment protester waves a Thai national flag outside Parliament in Bangkok'}), ('Protest',  {'ent_type': 'EVENT', 'data': 'Protest is a demonstration or declaration of disapproval or objection by action or gesture'}),   ('Antigovernment protester', {'ent_type': 'PERSON', 'data': 'Antigovernment protester'}), ('Thai national flag', {'ent_type': 'ENTITY', 'data': 'Thai national flag'}),   ('Parliament in Bangkok', {'ent_type': 'LOCATION', 'data': 'Parliament in Bangkok is a legislative body in the capital city of Thailand'})], 'edges':[('NEWS'               , 'Conflict'      ,   {'action': 'is about'}  ),       ('Conflict'           , 'Protest'       ,   {'action': 'is specifically about'}),         ('Antigovernment protester'   , 'Protest'       ,   {'action': 'organize'}),         ('Protest'          , 'Thai national flag', {'action': 'with'}),         ('Protest'          , 'Parliament in Bangkok', {'action': 'at place'})]",
    "Example 5 INPUT: 'ANA's R2D2 Jet Uses The Force to Transport Stars Between The 'Star Wars' Premieres - TheDesignAir', QA_OUTPUT: ' what  is the category?   : news <act  'is about' act> Culture <det 'Because it is about ANA's R2D2 Jet Uses The Force to Transport Stars Between The 'Star Wars' Premieres - TheDesignAir' det>  what  is the action about   : Culture <act  'is specifically about' act> transportation <det'ANA's R2D2 Jet Uses The Force to Transport Stars Between The 'Star Wars' Premieres - TheDesignAir'det>  who   is doing what        ?: <e 'ANA's R2D2 Jet'e>  transportation <act 'use' act>  what  is the cause ?        : transportation <act 'with' act> <e 'The Force' e>  where is this happening ?  : transportation  <act 'at place' act> <e'Star Wars' Premieres'e>  when  is this happening ?   : transportation  <act 'in time' act>   UNK ,  GRAPH_OUTPUT: 'nodes': [  ('Culture', {'ent_type': 'News Category', 'data': 'Because it is about ANA's R2D2 Jet Uses The Force to Transport Stars Between The 'Star Wars' Premieres - TheDesignAir'}), ('Transportation',  {'ent_type': 'EVENT', 'data': 'Transportation is the action of moving people or goods from one place to another'}),   ('ANA's R2D2 Jet', {'ent_type': 'THING', 'data': 'ANA's R2D2 Jet is an aircraft'}), ('The Force', {'ent_type': 'ENTITY', 'data': 'The Force'}),   ('Star Wars Premieres', {'ent_type': 'EVENT', 'data': 'Star Wars Premieres'}), ('TheDesignAir', {'ent_type': 'ORGANIZATION', 'data': 'TheDesignAir'})], 'edges':[('NEWS'               , 'Culture'      ,   {'action': 'is about'}         ('Culture'           , 'Transportation'       ,   {'action': 'is specifically about'}),         ('ANA's R2D2 Jet'   , 'Transportation'       ,   {'action': 'use'}),         ('Transportation'          , 'The Force', {'action': 'with'}),         ('Transportation'          , 'Star Wars Premieres', {'action': 'at place'})]"
    ]




###############---
